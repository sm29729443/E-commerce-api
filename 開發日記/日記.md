# 網站架構
這邊直接叫 claude 生成，幫我設計網站架構
![圖片](/img/ecommerce-system-tree.svg "E100")
# 資料庫設計
這邊主要是想練習 ER Model，一步一步根據概念模型、邏輯模型、物理模型的方式去設計看看。
## 概念模型
目前的理解是，概念模型就是種對現實業務場景的描述，而描述的方式有很多種，譬如，若是關注這個業務的執行過程，那可以用流程圖的方式去描述它，而若是關注這個業務各個角色的關係，則可以用 E-R Model 去描述它。  
像 E-R Model 這種用資料結構去呈現的方式，似乎也稱為 Structural View，而 BPMN、DFD 、流程圖這種的則稱為 Behavioral / Flow View。
### E-R(Entity-Relationship) MODEL
這裡設計概念模型的方式，是採 E-R Model 去設計，而 E-R Model 是一種將現實場景以 Entity、Relationship 的結構去映射的概念模型，簡單說就是將業務需求給抽象成 Entity、Relationship 來去描述這段業務需求。  
這裡說明一下幾個我比較難理解的點:  
Mandatory:指的是在一段關聯中，Entity 的每個 instance 都必須參與這段關係。  
Optional:指的是在一段關聯中，Entity 的每個 instance 是否可以不參與這段關係。  
Weak Entity:指的是一個 Entity，如果不依賴其他 Entity 就沒有意義，無法獨立存在。  
簡單來說，Mandatory、Optional 是用來判斷 instance 之間的關聯的，因為 Entity 彼此有關聯，只是代表他們「可能」有關聯，但 instance 可能是有或沒有的，所以 Mandatory、Optional 是一種以 instance 為單位去更細緻判斷關聯性的描述。

### Version 1  

```SQL

1.created_at和updated_at我打算在java中維護，因此不透過 DEFAULT 去設定。
2.MySQL 中，考慮到 FK 的設定會有額外效能浪費，故不設置。
3.INDEX我打算等實作業務時，根據具體分析再新增，故這裡先不使用。
4.業務上，採邏輯刪除。

CREATE DATABASE IF NOT EXISTS my_e_commerce;
USE my_e_commerce;
-- 會員表
CREATE TABLE member (
                        member_id INT PRIMARY KEY AUTO_INCREMENT,
                        username VARCHAR(50) NOT NULL UNIQUE,
                        password VARCHAR(100) NOT NULL,
                        email VARCHAR(100) NOT NULL UNIQUE,
                        phone VARCHAR(20) UNIQUE,
                        created_at TIMESTAMP NOT NULL,
                        updated_at TIMESTAMP NOT NULL,
                        status TINYINT NOT NULL COMMENT '0:禁用,1:正常',
                        is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 角色表
CREATE TABLE role(
                        role_id INT PRIMARY KEY AUTO_INCREMENT,
                        role_name VARCHAR(50) NOT NULL UNIQUE,
                        is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 會員-角色-連接表
CREATE TABLE member_role(
                                id INT PRIMARY KEY AUTO_INCREMENT,
                                member_id INT NOT NULL,
                                role_id INT NOT NULL,
                                is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 第三方登入表
CREATE TABLE oauth_connection (
                                  id INT PRIMARY KEY AUTO_INCREMENT,
                                  member_id INT NOT NULL,
                                  provider VARCHAR(20) NOT NULL COMMENT '第三方登入來源平台',
                                  provider_user_id VARCHAR(255) NOT NULL COMMENT 'user在第三方平台的user_id',
                                  is_deleted BOOLEAN DEFAULT FALSE NOT NULL,
                                  UNIQUE KEY uk_provider_id (provider, provider_user_id)
);

-- 商品表
CREATE TABLE product (
                         product_id INT PRIMARY KEY AUTO_INCREMENT,
                         name VARCHAR(100) NOT NULL,
                         description TEXT COMMENT '商品描述',
                         price INT NOT NULL,
                         status TINYINT NOT NULL COMMENT '0:未上架,1:上架,2:商品待審核',
                         created_at TIMESTAMP NOT NULL,
                         updated_at TIMESTAMP NOT NULL,
                         is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 商品SKU表
CREATE TABLE product_sku (
                             product_sku_id INT PRIMARY KEY AUTO_INCREMENT,
                             product_id INT NOT NULL,
                             sku_code VARCHAR(50) NOT NULL UNIQUE,
                             attributes JSON NOT NULL,
                             price INT NOT NULL,
                             stock INT NOT NULL,
                             status TINYINT NOT NULL COMMENT '0:停售,1:正常銷售',
                             is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);
-- 商品圖片表
CREATE TABLE product_image (
                               id INT PRIMARY KEY AUTO_INCREMENT,
                               product_id INT NOT NULL,
                               product_sku_id INT NULL,
                               image_url VARCHAR(255) NOT NULL,
                               image_type TINYINT NOT NULL COMMENT '1:主圖,2:詳情圖,3:規格圖',
                               sort_order INT NOT NULL DEFAULT 0 COMMENT '圖片排序權重',
                               created_at TIMESTAMP NOT NULL,
                               updated_at TIMESTAMP NOT NULL,
                               is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 商品分類表 (多級分類)
CREATE TABLE product_category (
                                  id INT PRIMARY KEY AUTO_INCREMENT,
                                  name VARCHAR(50) NOT NULL,
                                  parent_id INT COMMENT '這個分類的父分類',
                                  level INT NOT NULL COMMENT '分類的層級,1=頂級，2=二級，依此類推',
                                  path VARCHAR(255) NULL COMMENT '存儲完整路徑，如 "1,4,10"，便於未來查詢',
                                  sort_order INT NOT NULL DEFAULT 0,
                                  created_at TIMESTAMP NOT NULL,
                                  updated_at TIMESTAMP NOT NULL,
                                  is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 商品表新增分類欄位
ALTER TABLE product ADD COLUMN category_id INT NOT NULL;

-- 訂單表
CREATE TABLE orders (
                        id INT PRIMARY KEY AUTO_INCREMENT,
                        order_no VARCHAR(50) NOT NULL UNIQUE,
                        member_id INT NOT NULL,
                        total_amount INT NOT NULL,
                        recipient_name VARCHAR(50) NOT NULL,
                        recipient_phone VARCHAR(20) NOT NULL,
                        shipping_address TEXT NOT NULL,
                        payment_method VARCHAR(20) NOT NULL,
                        status TINYINT NOT NULL COMMENT '0:待付款,1:已付款,2:已發貨,3:已完成',
                        created_at TIMESTAMP NOT NULL,
                        updated_at TIMESTAMP NOT NULL,
                        is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);

-- 訂單項目表
CREATE TABLE order_item (
                            id INT PRIMARY KEY AUTO_INCREMENT,
                            order_id INT NOT NULL,
                            product_id INT NOT NULL,
                            product_sku_id INT NOT NULL,
                            product_name VARCHAR(100) NOT NULL,
                            product_attributes JSON,
                            price INT NOT NULL,
                            quantity INT NOT NULL,
                            is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);
-- 購物車表
CREATE TABLE cart(
                            cart_id INT PRIMARY KEY AUTO_INCREMENT,
                            member_id INT NOT NULL
);
-- 購物車項目表
CREATE TABLE cart_item (
                           cart_item_id INT PRIMARY KEY AUTO_INCREMENT,
                           cart_id INT NOT NULL,
                           product_id INT NOT NULL,
                           product_sku_id INT NOT NULL,
                           quantity INT NOT NULL,
                           created_at TIMESTAMP NOT NULL,
                           updated_at TIMESTAMP NOT NULL,
                           is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);
-- 支付紀錄表
CREATE TABLE payment_transaction (
                                     id INT PRIMARY KEY AUTO_INCREMENT,
                                     order_id INT NOT NULL,
                                     transaction_no VARCHAR(100) NOT NULL COMMENT '支付平台交易編號',
                                     amount INT NOT NULL,
                                     payment_method VARCHAR(20) NOT NULL,
                                     status TINYINT NOT NULL COMMENT '0:處理中,1:成功,2:失敗',
                                     created_at TIMESTAMP NOT NULL,
                                     updated_at TIMESTAMP NOT NULL,
                                     is_deleted BOOLEAN DEFAULT FALSE NOT NULL
);
```

#### 會員-訂單(1 Optional To Many Mandatory):  

會員創建訂單，一個會員會有多個訂單，但一個訂單只屬於某一個會員，且會員 instance 可以沒有任何關聯的訂單 instance，但訂單 instance 一定要關聯的到會員 instance，所以是 Optional To Mandatory。
而如果業務邏輯改成，會員刪除後，訂單依然存在，可能是要做資料分析之類的，那訂單 instance 也可以關聯不到會員 instance，此時會員-訂單就是 Optional To Optional。  
這裡當初有個疑問，若會員創建訂單，創建當下訂單肯定要求會員要存在才能創建，所以此時應該是 Optional To Mandatory，而創建後，會員刪除，訂單也還能存在，此時又是 Optional To Optional，但後來想想，創建訂單前，訂單 instance 根本還不存在，因此這問題根本不成立?
  
#### 會員-訂單-地址:  

會員-會員地址(Many Optional To Many Mandatory):會員可以沒有會員地址，但會員地址一定是某個會員的，且失去會員的會員地址，沒有任何意義，應該一併被刪除，因此是 Weak Entity。  
訂單-訂單快照地址(1 Mandatory To 1 Mandatory):同上概念。  
把地址拆分成兩個，這樣看起來，如果之後要新增 7-11、全家那種前端根據地圖選擇門市地址的功能，也只要把地址值帶入到後端，寫進訂單快照地址即可。
  
#### 訂單-訂單項目(1 Mandatory To Many Mandatory):  

當一個訂單成立時，就會將商品轉換成訂單項目，所以訂單項目就是商品在下單時刻的快照，而訂單項目一定是依賴訂單的，所以是 Weak Entity，而好像有些網站的業務邏輯會設計成可以空單，所以訂單可以是 Optional 的，因此這裡設計成*訂單*一定要**擁有***訂單項目*，所以關係是1 Mandatory To Many Mandatory。  
而訂單項目Entity依賴訂單Entity存在才有意義，所以是 Weak Entity。
  
#### 訂單-付款方式(1 Mandatory To 1 Optional):  

訂單要建立成功，一定要選擇一種付款方式，所以訂單必須在付款方式找的到其關聯，是 Mandatory，而付款方式並不一定要在訂單找到其關聯，所以是 Optional。

#### **商品-訂單項目(1 Optional To 1 Optional)**:  

因為訂單項目是商品的快照，並不依賴商品的存在，所以是 Optional 的。  
  
還有似乎某些場合一個訂單項目會對應到多個商品的樣子，但這裡就設計成 1 To 1，商品不分數量，就是視同一個商品，並且 sku 不同，也視為不同訂單項目。  

#### 商品-商品分類(Many Mandatory To 1 Optional):

這裡設計成，商品一定要分配商品分類，但商品分類下可能沒有商品，所以是 Many Mandatory To 1 Optional。

#### 管理員-商品分類(1 Optional To Many Optional):

商品分類只有管理員可以創建，但管理員如果被刪除，對應的商品分類也不會消失，所以是1 Optional To Many Optional。

#### 購物車-商品(1 Optional To Many Optional)

購物車內不一定有商品，商品也不一定被添加到購物車。

#### 會員-評論-商品:

設計成會員刪除，評論也跟者刪除，但商品刪除，商品的評論不會刪除。  
會員-評論: 1 Optional To Many Mandatory
評論-商品: 1 Optional To Many Optional。

#### 管理員-角色(權限)(1 Optional To Many Optional):

管理員被刪除時，角色或權限也不會被刪掉，所以是 1 Optional To Many Optional。

#### 角色-權限(Many Optional To Many Optional):

一個角色可以有多個權限，也可以完全沒有權限，而權限對應角色也是如此，所以是Many Optional To Many Optional。

# 專案架構

是單體架構，不是微服務，不過打算以功能劃分成不同 module 去開發，類似以下這種結構，目前只是示意圖，不是這個專案真正的功能劃分。

```text
e-commerce/
├── ec-common/               # 公共工具與組件
├── ec-product/              # 商品相關功能
├── ec-order/                # 訂單相關功能
├── ec-member/               # 會員相關功能
├── ec-cart/                 # 購物車功能
└── ec-application/          # 應用入口與配置
```

# ec-authorization